define ("mod_learningmap/learningmap",["exports","core/notification","core/templates","mod_learningmap/placestore"],function(a,b,c,d){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;c=e(c);d=e(d);function e(a){return a&&a.__esModule?a:{default:a}}var f=function(){c.default.prefetchTemplates(["mod_learningmap/cssskeleton"]);var v,w,x,y=null,z=null,A=null,B=null,C=null,D=document.getElementById("learningmap-editor-map"),E=document.getElementById("id_introeditor_text"),F=document.getElementById("learningmap-color-place"),G=document.getElementById("learningmap-color-visited"),H=document.getElementById("learningmap-color-path"),I=document.getElementById("learningmap-activity-setting"),J=document.getElementById("learningmap-activity-selector"),K=document.getElementById("learningmap-activity-starting"),L=document.getElementById("learningmap-activity-target"),M=document.getElementById("learningmap-advanced-settings-icon");if(J){J.addEventListener("change",function(){d.default.setActivityId(C,J.value);if(J.value){document.getElementById(C).classList.remove("learningmap-emptyplace")}else{document.getElementById(C).classList.add("learningmap-emptyplace")}u();f()});K.addEventListener("change",function(){if(K.checked){d.default.addStartingPlace(C)}else{d.default.removeStartingPlace(C)}f()});L.addEventListener("change",function(){if(L.checked){d.default.addTargetPlace(C);document.getElementById(C).classList.add("learningmap-targetplace")}else{d.default.removeTargetPlace(C);document.getElementById(C).classList.remove("learningmap-targetplace")}f()})}var N=document.getElementsByName("placestore")[0];if(N){d.default.loadJSON(N.value)}u();if(M){var Q=document.getElementById("learningmap-advanced-settings");M.addEventListener("click",function(){Q.removeAttribute("hidden")});var R=document.getElementById("learningmap-advanced-settings-close");if(R){R.addEventListener("click",function(){Q.setAttribute("hidden","")})}var S=document.getElementById("learningmap-hidepaths");if(S){if(d.default.getHidePaths()){S.checked=!0}S.addEventListener("change",function(){if(S.checked){d.default.setHidePaths(!0)}else{d.default.setHidePaths(!1)}t()})}var T=document.getElementById("learningmap-usecheckmark");if(T){if(d.default.getUseCheckmark()){T.checked=!0}T.addEventListener("change",function(){if(T.checked){d.default.setUseCheckmark(!0)}else{d.default.setUseCheckmark(!1)}t()})}}if(H){H.addEventListener("change",function(){d.default.setColor("stroke",H.value);t()});H.value=d.default.getColor("stroke")}if(F){F.addEventListener("change",function(){d.default.setColor("place",F.value);t()});F.value=d.default.getColor("place")}if(G){G.addEventListener("change",function(){d.default.setColor("visited",G.value);t()});G.value=d.default.getColor("visited")}if(E&&D){D.innerHTML=E.value}s();(function(){var a=document.getElementById("learningmap-background-image");if(a){a.addEventListener("load",function(){a.removeAttribute("height");var b=parseInt(a.getBBox().height),c=a.getBBox().width;d.default.setBackgroundDimensions(c,b);f();O.setAttribute("viewBox","0 0 "+d.default.width+" "+d.default.height);a.setAttribute("width",c);a.setAttribute("height",b)})}})();var O=document.getElementById("learningmap-svgmap-"+d.default.getMapid());(function(a){if(a){a.addEventListener("mousedown",c);a.addEventListener("mousemove",e);a.addEventListener("mouseup",g);a.addEventListener("mouseleave",g);a.addEventListener("touchstart",c);a.addEventListener("touchmove",e);a.addEventListener("touchend",g);a.addEventListener("touchleave",g);a.addEventListener("touchcancel",g)}function b(b){var c=a.getScreenCTM();if(b.touches){b=b.touches[0]}return{x:(b.clientX-c.e)/c.a,y:(b.clientY-c.f)/c.d}}function c(a){a.preventDefault();if(a.target.classList.contains("learningmap-draggable")){y=a.target;v=b(a);v.x-=parseInt(y.getAttributeNS(null,"cx"));v.y-=parseInt(y.getAttributeNS(null,"cy"));w=d.default.getPathsWithFid(y.id);x=d.default.getPathsWithSid(y.id)}}function e(a){a.preventDefault();if(y){var c=b(a),e=c.x-v.x,f=c.y-v.y;y.setAttributeNS(null,"cx",e);y.setAttributeNS(null,"cy",f);w.forEach(function(a){var b=document.getElementById(a.id);if(!(null===b)){if("path"==b.nodeName){var c=b.getAttribute("d"),d="M "+e+" "+f+" L"+c.split("L")[1];b.setAttribute("d",d)}else{b.setAttribute("x1",e);b.setAttribute("y1",f)}}});x.forEach(function(a){var b=document.getElementById(a.id);if(!(null===b)){if("path"==b.nodeName){var c=b.getAttribute("d"),d=c.split("L")[0]+"L "+e+" "+f;b.setAttribute("d",d)}else{b.setAttribute("x2",e);b.setAttribute("y2",f)}}})}}function g(a){a.preventDefault();y=null;n();f()}})(O);t();if(D){D.addEventListener("dblclick",g);D.addEventListener("click",m);D.addEventListener("contextmenu",function(b){b.preventDefault();a(b)},!1)}function a(a){n();if(I){if(a.target.classList.contains("learningmap-place")){a.target.classList.add("learningmap-selected-activity-selector");var b=d.default.getActivityId(a.target.id);I.setAttribute("style","top: "+a.offsetY+"px; left: "+a.offsetX+"px;");I.removeAttribute("hidden");document.getElementById("learningmap-activity-selector").value=b;if(d.default.isStartingPlace(a.target.id)){document.getElementById("learningmap-activity-starting").checked=!0}else{document.getElementById("learningmap-activity-starting").checked=!1}if(d.default.isTargetPlace(a.target.id)){document.getElementById("learningmap-activity-target").checked=!0}else{document.getElementById("learningmap-activity-target").checked=!1}C=a.target.id}else{e()}}}function e(){var a=document.getElementById(C);if(a){a.classList.remove("learningmap-selected-activity-selector")}I.setAttribute("hidden","")}var P=document.getElementById("id_introeditor_itemid_fieldset");if(P){var U=new MutationObserver(s);U.observe(P,{attributes:!0,childList:!0,subtree:!0})}function f(){if(E&&D){E.innerHTML=D.innerHTML}if(N){document.getElementsByName("placestore")[0].value=JSON.stringify(d.default.getPlacestore())}}function g(a){e();n();if(a.target.classList.contains("learningmap-mapcontainer")||a.target.classList.contains("learningmap-background-image")){l(a)}else if(a.target.classList.contains("learningmap-place")){if(B==a.target.id){B=null;m(a)}else{p(a)}}else if(a.target.classList.contains("learningmap-path")){r(a.target.id)}f()}function h(a){var b=document.createElementNS("http://www.w3.org/2000/svg","title");b.setAttribute("id",a);return b}function i(a,b,c,d,e){var f=document.createElementNS("http://www.w3.org/2000/svg","circle");f.setAttribute("class",d);f.setAttribute("id",e);f.setAttribute("cx",a);f.setAttribute("cy",b);f.setAttribute("r",c);return f}function j(a,b,c,d,e,f){var g=document.createElementNS("http://www.w3.org/2000/svg","path");g.setAttribute("class",e);g.setAttribute("id",f);g.setAttribute("d","M "+a+" "+b+" L "+c+" "+d);return g}function k(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null,d=document.createElementNS("http://www.w3.org/2000/svg","a");d.setAttribute("id",b);d.setAttribute("xlink:href","");d.appendChild(a);if(!(null===c)){d.appendChild(c)}return d}function l(a){var b=document.getElementById("placesGroup"),c="p"+d.default.getId(),e="a"+d.default.getId(),f=a.target.getScreenCTM();if(a.touches){a=a.touches[0]}var g=(a.clientX-f.e)/f.a,j=(a.clientY-f.f)/f.d;b.appendChild(k(i(g,j,10,"learningmap-place learningmap-draggable learningmap-emptyplace",c),e,h("title"+c)));d.default.addPlace(c,e)}function m(a){a.preventDefault();e();if(a.target.classList.contains("learningmap-place")&&null===y){if(null===z){z=a.target.id;document.getElementById(z).classList.add("learningmap-selected")}else{A=a.target.id;var b=parseInt(z.replace("p","")),c=parseInt(A.replace("p",""));if(c==b){return}if(c<b){var d=c;c=b;b=d}o(b,c);var f=document.getElementById(z);if(f){f.classList.remove("learningmap-selected")}z=null;B=A;A=null}}else{n();z=null}}function n(){Array.from(document.getElementsByClassName("learningmap-selected")).forEach(function(a){a.classList.remove("learningmap-selected")});Array.from(document.getElementsByClassName("learningmap-selected-activity-selector")).forEach(function(a){a.classList.remove("learningmap-selected-activity-selector")})}function o(a,b){var c="p"+a+"_"+b;if(null===document.getElementById(c)){var e=document.getElementById("pathsGroup"),f=document.getElementById("p"+a),g=document.getElementById("p"+b);if(e&&f&&g){e.appendChild(j(f.cx.baseVal.value,f.cy.baseVal.value,g.cx.baseVal.value,g.cy.baseVal.value,"learningmap-path",c));d.default.addPath(c,"p"+a,"p"+b)}}}function p(a){var b=document.getElementById(a.target.id),c=b.parentNode;q(a.target.id);d.default.removePlace(a.target.id);c.removeChild(b);c.parentNode.removeChild(c);f()}function q(a){d.default.getTouchingPaths(a).forEach(function(a){r(a.id)})}function r(a){var b=document.getElementById(a);if(!(null===b)){b.parentNode.removeChild(b);d.default.removePath(a)}}function s(){var a=document.getElementsByClassName("realpreview");if(0<a.length){var b=document.getElementById("learningmap-background-image");b.setAttribute("xlink:href",a[0].getAttribute("src").split("?")[0])}}function t(){c.default.renderForPromise("mod_learningmap/cssskeleton",d.default.getPlacestore()).then(function(a){var b=a.html,d=a.js;c.default.replaceNode("#learningmap-svgstyle",b,d);f();return!0}).catch(function(a){return(0,b.exception)(a)})}function u(){var a=d.default.getAllActivities(),b=Array.from(J.getElementsByTagName("option"));b.forEach(function(b){if(a.includes(b.value)){b.classList.add("learningmap-used-activity")}else{b.classList.remove("learningmap-used-activity")}})}};a.init=f});
//# sourceMappingURL=learningmap.min.js.map
