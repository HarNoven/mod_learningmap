define ("mod_learningmap/learningmap",["exports","core/notification","core/templates"],function(a,b,c){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;c=function(a){return a&&a.__esModule?a:{default:a}}(c);a.init=function init(){var w,x,y=null,z=null,A=null,B=null,C=document.getElementById("learningmap-editor-map"),D=document.getElementById("id_introeditor_text"),E=document.getElementById("learningmap-activity-setting"),F=document.getElementById("learningmap-activity-selector"),G=document.getElementById("learningmap-activity-starting"),H=document.getElementById("learningmap-activity-target"),I=document.getElementById("learningmap-color-place"),J=document.getElementById("learningmap-color-visited"),K=document.getElementById("learningmap-color-path");if(F){F.addEventListener("change",function(){s(B,F.value)});G.addEventListener("change",function(){if(G.checked){L.startingplaces.push(B)}else{L.startingplaces=L.startingplaces.filter(function(a){return a!=B})}e()});H.addEventListener("change",function(){if(H.checked){L.targetplaces.push(B)}else{L.targetplaces=L.targetplaces.filter(function(a){return a!=B})}e()})}var L={id:0,places:[],paths:[],startingplaces:[],targetplaces:[],placecolor:"#c01c28",strokecolor:"#ffffff",visitedcolor:"#26a269",height:100,width:800,editmode:!0};try{var P=JSON.parse(document.getElementsByName("placestore")[0].value);L={placestore:L,fromjson:P};t()}catch(a){}if(K){K.addEventListener("change",function(){L.strokecolor=K.value;v();e()});K.value=L.strokecolor}if(I){I.addEventListener("change",function(){L.placecolor=I.value;v();e()});I.value=L.placecolor}if(J){J.addEventListener("change",function(){L.visitedcolor=J.value;v();e()});J.value=L.visitedcolor}C.innerHTML=D.value;t();C.addEventListener("dblclick",f);C.addEventListener("click",l);C.addEventListener("contextmenu",function(b){a(b);b.preventDefault()},!1);function a(a){if(B){document.getElementById(B).classList.remove("learningmap-selected-activity-selector")}if(E){if(a.target.classList.contains("learningmap-place")){a.target.classList.add("learningmap-selected-activity-selector");var b=r(a.target.id);E.setAttribute("style","top: "+a.offsetY+"px; left: "+a.offsetX+"px;");E.removeAttribute("hidden");document.getElementById("learningmap-activity-selector").value=b;if(L.startingplaces.includes(a.target.id)){document.getElementById("learningmap-activity-starting").setAttribute("checked","on")}else{document.getElementById("learningmap-activity-starting").removeAttribute("checked","")}if(L.targetplaces.includes(a.target.id)){document.getElementById("learningmap-activity-target").setAttribute("checked","on")}else{document.getElementById("learningmap-activity-target").removeAttribute("checked","")}B=a.target.id}else{d()}}}function d(){var a=document.getElementById(B);if(a){a.classList.remove("learningmap-selected-activity-selector")}E.setAttribute("hidden","")}var M=document.getElementById("id_introeditor_itemid_fieldset"),N=new MutationObserver(t);N.observe(M,{attributes:!0,childList:!0,subtree:!0});(function(a){a.addEventListener("mousedown",c);a.addEventListener("mousemove",d);a.addEventListener("mouseup",f);a.addEventListener("mouseleave",f);a.addEventListener("touchstart",c);a.addEventListener("touchmove",d);a.addEventListener("touchend",f);a.addEventListener("touchleave",f);a.addEventListener("touchcancel",f);function b(b){var c=a.getScreenCTM();if(b.touches){b=b.touches[0]}return{x:(b.clientX-c.e)/c.a,y:(b.clientY-c.f)/c.d}}function c(a){if(a.target.classList.contains("learningmap-draggable")){w=a.target;x=b(a);x.x-=parseFloat(w.getAttributeNS(null,"cx"));x.y-=parseFloat(w.getAttributeNS(null,"cy"))}}function d(a){if(w){a.preventDefault();var c=b(a),e=c.x-x.x,f=c.y-x.y;w.setAttributeNS(null,"cx",e);w.setAttributeNS(null,"cy",f);var d=L.paths.filter(function(a){return a.fid==w.id});d.forEach(function(a){var b=document.getElementById(a.id);if(!(null===b)){b.setAttribute("x1",e);b.setAttribute("y1",f)}});var g=L.paths.filter(function(a){return a.sid==w.id});g.forEach(function(a){var b=document.getElementById(a.id);if(!(null===b)){b.setAttribute("x2",e);b.setAttribute("y2",f)}})}}function f(){w=!1;e()}})(document.getElementById("learningmap-svgmap"));var O=document.getElementById("learningmap-background-image");O.addEventListener("load",function(){var a=parseInt(O.getBBox().height),b=O.getBBox().width;L.height=a;L.width=b;e();u()});function e(){var a=document.getElementById("learningmap-editor-map"),b=document.getElementById("id_introeditor_text");b.innerHTML=a.innerHTML;document.getElementsByName("placestore")[0].value=JSON.stringify(L)}function f(a){d();if(a.target.classList.contains("learningmap-mapcontainer")||a.target.classList.contains("learningmap-background-image")){k(a)}else if(a.target.classList.contains("learningmap-place")){if(A==a.target.id){A=null;l(a)}else{n(a)}}else if(a.target.classList.contains("learningmap-path")){p(a.target.id)}e()}function g(a){var b=document.createElementNS("http://www.w3.org/2000/svg","title");b.setAttribute("id",a);return b}function h(a,b,c,d,e){var f=document.createElementNS("http://www.w3.org/2000/svg","circle");f.setAttribute("class",d);f.setAttribute("id",e);f.setAttribute("cx",a);f.setAttribute("cy",b);f.setAttribute("r",c);return f}function i(a,b,c,d,e,f){var g=document.createElementNS("http://www.w3.org/2000/svg","line");g.setAttribute("class",e);g.setAttribute("id",f);g.setAttribute("x1",a);g.setAttribute("y1",b);g.setAttribute("x2",c);g.setAttribute("y2",d);return g}function j(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null,d=document.createElementNS("http://www.w3.org/2000/svg","a");d.setAttribute("id",b);d.setAttribute("xlink:href","");d.appendChild(a);if(!(null===c)){d.appendChild(c)}return d}function k(a){var b=document.getElementById("placesGroup"),c="p"+L.id,d="a"+L.id,e=a.target.getScreenCTM();if(a.touches){a=a.touches[0]}var f=(a.clientX-e.e)/e.a,i=(a.clientY-e.f)/e.d;b.appendChild(j(h(f,i,10,"learningmap-place learningmap-draggable",c),d,g("title"+c)));L.places.push({id:c,linkId:d,linkedActivity:null});if(1==L.places.length){L.startingplaces.push(c)}L.id++}function l(a){d();if(a.target.classList.contains("learningmap-place")){a.preventDefault();if(null===y){y=a.target.id;document.getElementById(y).classList.add("learningmap-selected")}else{z=a.target.id;var b=parseInt(y.replace("p","")),c=parseInt(z.replace("p",""));if(c==b){return}if(c<b){var e=c;c=b;b=e}m(b,c);var f=document.getElementById(y);if(f){f.classList.remove("learningmap-selected")}y=null;A=z;z=null}}else{var g=document.getElementById(y);if(!(null===g)){g.classList.remove("learningmap-selected")}y=null}}function m(a,b){var c="p"+a+"_"+b;if(null===document.getElementById(c)){var d=document.getElementById("pathsGroup"),e=document.getElementById("p"+a),f=document.getElementById("p"+b);if(d&&e&&f){d.appendChild(i(e.cx.baseVal.value,e.cy.baseVal.value,f.cx.baseVal.value,f.cy.baseVal.value,"learningmap-path",c));L.paths.push({id:c,fid:"p"+a,sid:"p"+b})}}}function n(a){var b=document.getElementById(a.target.id),c=b.parentNode;o(a.target.id);L.places=L.places.filter(function(b){return b.id!=a.target.id});L.startingplaces=L.startingplaces.filter(function(b){return b!=a.target.id});L.targetplaces=L.targetplaces.filter(function(b){return b!=a.target.id});c.removeChild(b);c.parentNode.removeChild(c);e()}function o(a){L.paths.forEach(function(b){if(b.fid==a||b.sid==a){p(b.id)}})}function p(a){var b=document.getElementById(a);if(!(null===b)){b.parentNode.removeChild(b);q(a)}}function q(a){L.paths=L.paths.filter(function(b){return a!=b.id})}function r(a){var b=L.places.filter(function(b){return a==b.id});if(0<b.length){return b[0].linkedActivity}else{return null}}function s(a,b){var c=L.places.filter(function(b){return a==b.id});if(0<c.length){c[0].linkedActivity=b}e()}function t(){var a=document.getElementsByClassName("realpreview");if(0<a.length){var b=document.getElementById("learningmap-background-image");b.setAttribute("xlink:href",a[0].getAttribute("src").split("?")[0])}}function u(){var a=document.getElementById("learningmap-svgmap");a.setAttribute("viewBox","0 0 "+L.width+" "+L.height)}function v(){c.default.renderForPromise("mod_learningmap/cssskeleton",L).then(function(a){var b=a.html;C.innerHTML=C.innerHTML.replace(/<style[\s\S]*style>/i,b);return!0}).catch(function(a){return(0,b.exception)(a)})}}});
//# sourceMappingURL=learningmap.min.js.map
