define ("mod_learningmap/learningmap",["exports","core/notification","core/templates","mod_learningmap/placestore"],function(a,b,c,d){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;c=e(c);d=e(d);function e(a){return a&&a.__esModule?a:{default:a}}var f=function(){c.default.prefetchTemplates(["mod_learningmap/cssskeleton"]);var u,v,w,x=null,y=null,z=null,A=null,B=null,C=document.getElementById("learningmap-editor-map"),D=document.getElementById("id_introeditor_text"),E=document.getElementById("learningmap-color-place"),F=document.getElementById("learningmap-color-visited"),G=document.getElementById("learningmap-color-path"),H=document.getElementById("learningmap-hidepaths"),I=document.getElementById("learningmap-activity-setting"),J=document.getElementById("learningmap-activity-selector"),K=document.getElementById("learningmap-activity-starting"),L=document.getElementById("learningmap-activity-target");if(J){J.addEventListener("change",function(){d.default.setActivityId(B,J.value);if(J.value){document.getElementById(B).classList.remove("learningmap-emptyplace")}else{document.getElementById(B).classList.add("learningmap-emptyplace")}f()});K.addEventListener("change",function(){if(K.checked){d.default.addStartingPlace(B)}else{d.default.removeStartingPlace(B)}f()});L.addEventListener("change",function(){if(L.checked){d.default.addTargetPlace(B);document.getElementById(B).classList.add("learningmap-targetplace")}else{d.default.removeTargetPlace(B);document.getElementById(B).classList.remove("learningmap-targetplace")}f()})}var M=document.getElementsByName("placestore")[0];if(M){d.default.loadJSON(M.value)}if(G){G.addEventListener("change",function(){d.default.setColor("stroke",G.value);t()});G.value=d.default.getColor("stroke")}if(E){E.addEventListener("change",function(){d.default.setColor("place",E.value);t()});E.value=d.default.getColor("place")}if(F){F.addEventListener("change",function(){d.default.setColor("visited",F.value);t()});F.value=d.default.getColor("visited")}if(H){if(d.default.getHidePaths()){H.checked=!0}H.addEventListener("change",function(){if(H.checked){d.default.setHidePaths(!0)}else{d.default.setHidePaths(!1)}t()})}if(D&&C){C.innerHTML=D.value}s();(function(){var a=document.getElementById("learningmap-background-image");if(a){a.addEventListener("load",function(){a.removeAttribute("height");var b=parseInt(a.getBBox().height),c=a.getBBox().width;d.default.setBackgroundDimensions(c,b);f();N.setAttribute("viewBox","0 0 "+d.default.width+" "+d.default.height);a.setAttribute("width",c);a.setAttribute("height",b)})}})();var N=document.getElementById("learningmap-svgmap-"+d.default.getMapid());(function(a){if(a){a.addEventListener("mousedown",c);a.addEventListener("mousemove",e);a.addEventListener("mouseup",g);a.addEventListener("mouseleave",g);a.addEventListener("touchstart",c);a.addEventListener("touchmove",e);a.addEventListener("touchend",g);a.addEventListener("touchleave",g);a.addEventListener("touchcancel",g)}function b(b){var c=a.getScreenCTM();if(b.touches){b=b.touches[0]}return{x:(b.clientX-c.e)/c.a,y:(b.clientY-c.f)/c.d}}function c(a){a.preventDefault();if(a.target.classList.contains("learningmap-draggable")){x=a.target;u=b(a);u.x-=parseInt(x.getAttributeNS(null,"cx"));u.y-=parseInt(x.getAttributeNS(null,"cy"));v=d.default.getPathsWithFid(x.id);w=d.default.getPathsWithSid(x.id)}}function e(a){a.preventDefault();if(x){var c=b(a),e=c.x-u.x,f=c.y-u.y;x.setAttributeNS(null,"cx",e);x.setAttributeNS(null,"cy",f);v.forEach(function(a){var b=document.getElementById(a.id);if(!(null===b)){var c=b.getAttribute("d"),d="M "+e+" "+f+" L"+c.split("L")[1];b.setAttribute("d",d)}});w.forEach(function(a){var b=document.getElementById(a.id);if(!(null===b)){var c=b.getAttribute("d"),d=c.split("L")[0]+"L "+e+" "+f;b.setAttribute("d",d)}})}}function g(a){a.preventDefault();x=null;n();f()}})(N);t();if(C){C.addEventListener("dblclick",g);C.addEventListener("click",m);C.addEventListener("contextmenu",function(b){b.preventDefault();a(b)},!1)}function a(a){n();if(I){if(a.target.classList.contains("learningmap-place")){a.target.classList.add("learningmap-selected-activity-selector");var b=d.default.getActivityId(a.target.id);I.setAttribute("style","top: "+a.offsetY+"px; left: "+a.offsetX+"px;");I.removeAttribute("hidden");document.getElementById("learningmap-activity-selector").value=b;if(d.default.isStartingPlace(a.target.id)){document.getElementById("learningmap-activity-starting").checked=!0}else{document.getElementById("learningmap-activity-starting").checked=!1}if(d.default.isTargetPlace(a.target.id)){document.getElementById("learningmap-activity-target").checked=!0}else{document.getElementById("learningmap-activity-target").checked=!1}B=a.target.id}else{e()}}}function e(){var a=document.getElementById(B);if(a){a.classList.remove("learningmap-selected-activity-selector")}I.setAttribute("hidden","")}var O=document.getElementById("id_introeditor_itemid_fieldset");if(O){var P=new MutationObserver(s);P.observe(O,{attributes:!0,childList:!0,subtree:!0})}function f(){if(D&&C){D.innerHTML=C.innerHTML}if(M){document.getElementsByName("placestore")[0].value=JSON.stringify(d.default.getPlacestore())}}function g(a){e();n();if(a.target.classList.contains("learningmap-mapcontainer")||a.target.classList.contains("learningmap-background-image")){l(a)}else if(a.target.classList.contains("learningmap-place")){if(A==a.target.id){A=null;m(a)}else{p(a)}}else if(a.target.classList.contains("learningmap-path")){r(a.target.id)}f()}function h(a){var b=document.createElementNS("http://www.w3.org/2000/svg","title");b.setAttribute("id",a);return b}function i(a,b,c,d,e){var f=document.createElementNS("http://www.w3.org/2000/svg","circle");f.setAttribute("class",d);f.setAttribute("id",e);f.setAttribute("cx",a);f.setAttribute("cy",b);f.setAttribute("r",c);return f}function j(a,b,c,d,e,f){var g=document.createElementNS("http://www.w3.org/2000/svg","path");g.setAttribute("class",e);g.setAttribute("id",f);g.setAttribute("d","M "+a+" "+b+" L "+c+" "+d);return g}function k(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null,d=document.createElementNS("http://www.w3.org/2000/svg","a");d.setAttribute("id",b);d.setAttribute("xlink:href","");d.appendChild(a);if(!(null===c)){d.appendChild(c)}return d}function l(a){var b=document.getElementById("placesGroup"),c="p"+d.default.getId(),e="a"+d.default.getId(),f=a.target.getScreenCTM();if(a.touches){a=a.touches[0]}var g=(a.clientX-f.e)/f.a,j=(a.clientY-f.f)/f.d;b.appendChild(k(i(g,j,10,"learningmap-place learningmap-draggable learningmap-emptyplace",c),e,h("title"+c)));d.default.addPlace(c,e)}function m(a){a.preventDefault();e();if(a.target.classList.contains("learningmap-place")&&null===x){if(null===y){y=a.target.id;document.getElementById(y).classList.add("learningmap-selected")}else{z=a.target.id;var b=parseInt(y.replace("p","")),c=parseInt(z.replace("p",""));if(c==b){return}if(c<b){var d=c;c=b;b=d}o(b,c);var f=document.getElementById(y);if(f){f.classList.remove("learningmap-selected")}y=null;A=z;z=null}}else{n();y=null}}function n(){Array.from(document.getElementsByClassName("learningmap-selected")).forEach(function(a){a.classList.remove("learningmap-selected")});Array.from(document.getElementsByClassName("learningmap-selected-activity-selector")).forEach(function(a){a.classList.remove("learningmap-selected-activity-selector")})}function o(a,b){var c="p"+a+"_"+b;if(null===document.getElementById(c)){var e=document.getElementById("pathsGroup"),f=document.getElementById("p"+a),g=document.getElementById("p"+b);if(e&&f&&g){e.appendChild(j(f.cx.baseVal.value,f.cy.baseVal.value,g.cx.baseVal.value,g.cy.baseVal.value,"learningmap-path",c));d.default.addPath(c,"p"+a,"p"+b)}}}function p(a){var b=document.getElementById(a.target.id),c=b.parentNode;q(a.target.id);d.default.removePlace(a.target.id);c.removeChild(b);c.parentNode.removeChild(c);f()}function q(a){d.default.getTouchingPaths(a).forEach(function(a){r(a.id)})}function r(a){var b=document.getElementById(a);if(!(null===b)){b.parentNode.removeChild(b);d.default.removePath(a)}}function s(){var a=document.getElementsByClassName("realpreview");if(0<a.length){var b=document.getElementById("learningmap-background-image");b.setAttribute("xlink:href",a[0].getAttribute("src").split("?")[0])}}function t(){c.default.renderForPromise("mod_learningmap/cssskeleton",d.default.getPlacestore()).then(function(a){var b=a.html,d=a.js;c.default.replaceNode("#learningmap-svgstyle",b,d);f();return!0}).catch(function(a){return(0,b.exception)(a)})}};a.init=f});
//# sourceMappingURL=learningmap.min.js.map
