{"version":3,"sources":["../src/learningmap.js"],"names":["init","Templates","prefetchTemplates","offset","upd1","upd2","selectedElement","firstPlace","secondPlace","lastTarget","elementForActivitySelector","mapdiv","document","getElementById","code","colorChooserPlace","colorChooserVisited","colorChooserPath","activitySetting","activitySelector","activityStarting","activityTarget","advancedSettingsIcon","treeView","querySelector","setAttribute","iconView","setTimeout","dispatchEvent","Event","addEventListener","placestore","setActivityId","value","classList","remove","add","updateActivities","updateCode","checked","addStartingPlace","removeStartingPlace","addTargetPlace","removeTargetPlace","placestoreInput","getElementsByName","loadJSON","advancedSettings","removeAttribute","advancedSettingsClose","hidepaths","getHidePaths","setHidePaths","updateCSS","usecheckmark","getUseCheckmark","setUseCheckmark","setColor","getColor","innerHTML","refreshBackgroundImage","background","height","parseInt","getBBox","width","setBackgroundDimensions","svg","getMapid","el","startDrag","drag","endDrag","getMousePosition","evt","CTM","getScreenCTM","touches","x","clientX","e","a","y","clientY","f","d","preventDefault","target","contains","getAttributeNS","getPathsWithFid","id","getPathsWithSid","coord","cx","cy","setAttributeNS","forEach","p","nodeName","pathDeclaration","getAttribute","newPathDeclaration","split","unselectAll","dblclickHandler","clickHandler","showContextMenu","activityId","getActivityId","offsetY","offsetX","isStartingPlace","isTargetPlace","hideContextMenu","backgroundfileNode","observer","MutationObserver","observe","attributes","childList","subtree","JSON","stringify","getPlacestore","event","addPlace","removePlace","removePath","title","createElementNS","circle","r","classes","path","x1","y1","x2","y2","link","child","appendChild","placesgroup","placeId","getId","linkId","fid","replace","sid","z","addPath","first","Array","from","getElementsByClassName","pid","pathsgroup","second","baseVal","place","parent","parentNode","removePathsTouchingPlace","removeChild","getTouchingPaths","previewimage","length","renderForPromise","then","html","js","replaceNode","catch","ex","activities","getAllActivities","options","getElementsByTagName","n","includes"],"mappings":"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","sourcesContent":["// mod_learningmap - A moodle plugin for easy visualization of learning paths\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU Affero General Public License as\n// published by the Free Software Foundation, either version 3 of the\n// License, or (at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU Affero General Public License for more details.\n//\n// You should have received a copy of the GNU Affero General Public License\n// along with this program.  If not, see <https://www.gnu.org/licenses/>.\n\nimport {exception as displayException} from 'core/notification';\nimport Templates from 'core/templates';\nimport placestore from 'mod_learningmap/placestore';\n\nexport const init = () => {\n    // Load the needed template on startup for better execution speed.\n    Templates.prefetchTemplates(['mod_learningmap/cssskeleton']);\n\n    // Variable for storing the mouse offset\n    var offset;\n\n    // Variables for storing the paths that need update of the first (upd1) or\n    // the second (upd2) coordinates.\n    var upd1, upd2;\n\n    // Variables for handling the currently selected elements\n    var selectedElement = null,\n        firstPlace = null,\n        secondPlace = null,\n        lastTarget = null;\n\n    // Variable for storing the selected element for the activity selector\n    var elementForActivitySelector = null;\n\n    // DOM nodes for the editor\n    let mapdiv = document.getElementById('learningmap-editor-map');\n    let code = document.getElementById('id_introeditor_text');\n    let colorChooserPlace = document.getElementById('learningmap-color-place');\n    let colorChooserVisited = document.getElementById('learningmap-color-visited');\n    let colorChooserPath = document.getElementById('learningmap-color-path');\n\n\n    // DOM nodes for the activity selector\n    let activitySetting = document.getElementById('learningmap-activity-setting');\n    let activitySelector = document.getElementById('learningmap-activity-selector');\n    let activityStarting = document.getElementById('learningmap-activity-starting');\n    let activityTarget = document.getElementById('learningmap-activity-target');\n    let advancedSettingsIcon = document.getElementById('learningmap-advanced-settings-icon');\n\n    // Hide tree view as there is no preview file we can attach to\n    let treeView = document.querySelector('.fp-viewbar .fp-vb-tree');\n    if (treeView) {\n        treeView.setAttribute('style', 'display: none;');\n    }\n\n    // Trigger click event on icon view to ensure that tree view is not active.\n    let iconView = document.querySelector('.fp-viewbar .fp-vb-icons');\n    if (iconView) {\n        // Handle possible delay in form loading.\n        setTimeout(() => {\n            iconView.dispatchEvent(new Event('click'));\n        }, 1000);\n    }\n\n    // Attach listeners to the activity selector\n    if (activitySelector) {\n        // Show places that are not linked to an activity\n        activitySelector.addEventListener('change', function() {\n            placestore.setActivityId(elementForActivitySelector, activitySelector.value);\n            if (activitySelector.value) {\n                document.getElementById(elementForActivitySelector).classList.remove('learningmap-emptyplace');\n            } else {\n                document.getElementById(elementForActivitySelector).classList.add('learningmap-emptyplace');\n            }\n            updateActivities();\n            updateCode();\n        });\n        // Add / remove a place to the starting places array\n        activityStarting.addEventListener('change', function() {\n            if (activityStarting.checked) {\n                placestore.addStartingPlace(elementForActivitySelector);\n            } else {\n                placestore.removeStartingPlace(elementForActivitySelector);\n            }\n            updateCode();\n        });\n        // Add / remove a place to the target places array\n        activityTarget.addEventListener('change', function() {\n            if (activityTarget.checked) {\n                placestore.addTargetPlace(elementForActivitySelector);\n                document.getElementById(elementForActivitySelector).classList.add('learningmap-targetplace');\n            } else {\n                placestore.removeTargetPlace(elementForActivitySelector);\n                document.getElementById(elementForActivitySelector).classList.remove('learningmap-targetplace');\n            }\n            updateCode();\n        });\n    }\n\n    // Load placestore values from the hidden input field\n    let placestoreInput = document.getElementsByName('placestore')[0];\n    if (placestoreInput) {\n        placestore.loadJSON(placestoreInput.value);\n    }\n\n    // Mark all activities in the placestore as \"used\".\n    updateActivities();\n\n    // Attach listeners to the advanced settings div\n    if (advancedSettingsIcon) {\n        let advancedSettings = document.getElementById('learningmap-advanced-settings');\n        advancedSettingsIcon.addEventListener('click', function() {\n            advancedSettings.removeAttribute('hidden');\n        });\n        let advancedSettingsClose = document.getElementById('learningmap-advanced-settings-close');\n        if (advancedSettingsClose) {\n            advancedSettingsClose.addEventListener('click', function() {\n                advancedSettings.setAttribute('hidden', '');\n            });\n        }\n\n        let hidepaths = document.getElementById('learningmap-hidepaths');\n        // Attach a listener to the hidepaths checkbox\n        if (hidepaths) {\n            if (placestore.getHidePaths()) {\n                hidepaths.checked = true;\n            }\n            hidepaths.addEventListener('change', function() {\n                if (hidepaths.checked) {\n                    placestore.setHidePaths(true);\n                } else {\n                    placestore.setHidePaths(false);\n                }\n                updateCSS();\n            });\n        }\n\n        let usecheckmark = document.getElementById('learningmap-usecheckmark');\n        // Attach a listener to the usecheckmark checkbox\n        if (usecheckmark) {\n            if (placestore.getUseCheckmark()) {\n                usecheckmark.checked = true;\n            }\n            usecheckmark.addEventListener('change', function() {\n                if (usecheckmark.checked) {\n                    placestore.setUseCheckmark(true);\n                } else {\n                    placestore.setUseCheckmark(false);\n                }\n                updateCSS();\n            });\n        }\n}\n\n    // Attach listener to the color choosers for paths\n    if (colorChooserPath) {\n        colorChooserPath.addEventListener('change', function() {\n            placestore.setColor('stroke', colorChooserPath.value);\n            updateCSS();\n        });\n        colorChooserPath.value = placestore.getColor('stroke');\n    }\n\n    // Attach listener to the color choosers for places\n    if (colorChooserPlace) {\n        colorChooserPlace.addEventListener('change', function() {\n            placestore.setColor('place', colorChooserPlace.value);\n            updateCSS();\n        });\n        colorChooserPlace.value = placestore.getColor('place');\n    }\n\n    // Attach listener to the color choosers for visited places\n    if (colorChooserVisited) {\n        colorChooserVisited.addEventListener('change', function() {\n            placestore.setColor('visited', colorChooserVisited.value);\n            updateCSS();\n        });\n        colorChooserVisited.value = placestore.getColor('visited');\n    }\n\n    // Get SVG code from the (hidden) textarea field\n    if (code && mapdiv) {\n        mapdiv.innerHTML = code.value;\n    }\n    // Reload background image to get the correct width and height values\n    refreshBackgroundImage();\n    registerBackgroundListener();\n    updateCode();\n\n    // Enable dragging of places\n    let svg = document.getElementById('learningmap-svgmap-' + placestore.getMapid());\n    makeDraggable(svg);\n\n    // Refresh stylesheet values from placestore\n    updateCSS();\n\n    // Add listeners for clicking and context menu\n    if (mapdiv) {\n        mapdiv.addEventListener('dblclick', dblclickHandler);\n        mapdiv.addEventListener('click', clickHandler);\n\n        mapdiv.addEventListener('contextmenu', function(e) {\n            e.preventDefault();\n            showContextMenu(e);\n        }, false);\n    }\n    /**\n     * Shows the context menu at the current mouse position\n     * @param {*} e\n     */\n    function showContextMenu(e) {\n        unselectAll();\n        if (activitySetting) {\n            if (e.target.classList.contains('learningmap-place')) {\n                e.target.classList.add('learningmap-selected-activity-selector');\n                let activityId = placestore.getActivityId(e.target.id);\n                activitySetting.setAttribute('style', 'top: ' + e.offsetY + 'px; left: ' + e.offsetX + 'px;');\n                activitySetting.removeAttribute('hidden');\n                document.getElementById('learningmap-activity-selector').value = activityId;\n                if (placestore.isStartingPlace(e.target.id)) {\n                    document.getElementById('learningmap-activity-starting').checked = true;\n                } else {\n                    document.getElementById('learningmap-activity-starting').checked = false;\n                }\n                if (placestore.isTargetPlace(e.target.id)) {\n                    document.getElementById('learningmap-activity-target').checked = true;\n                } else {\n                    document.getElementById('learningmap-activity-target').checked = false;\n                }\n                elementForActivitySelector = e.target.id;\n            } else {\n                hideContextMenu();\n            }\n        }\n    }\n\n    /**\n     * Hides the context menu\n     */\n    function hideContextMenu() {\n        let e = document.getElementById(elementForActivitySelector);\n        if (e) {\n            e.classList.remove('learningmap-selected-activity-selector');\n        }\n        activitySetting.setAttribute('hidden', '');\n    }\n\n    let backgroundfileNode = document.getElementById('id_introeditor_itemid_fieldset');\n    if (backgroundfileNode) {\n        let observer = new MutationObserver(refreshBackgroundImage);\n        observer.observe(backgroundfileNode, {attributes: true, childList: true, subtree: true});\n    }\n    /**\n     * Enables dragging on an DOM node\n     * @param {*} el\n     */\n    function makeDraggable(el) {\n        if (el) {\n            el.addEventListener('mousedown', startDrag);\n            el.addEventListener('mousemove', drag);\n            el.addEventListener('mouseup', endDrag);\n            el.addEventListener('mouseleave', endDrag);\n            el.addEventListener('touchstart', startDrag);\n            el.addEventListener('touchmove', drag);\n            el.addEventListener('touchend', endDrag);\n            el.addEventListener('touchleave', endDrag);\n            el.addEventListener('touchcancel', endDrag);\n        }\n\n        /**\n         * Helper function for getting the right coordinates from the mouse\n         * @param {*} evt\n         * @returns {object}\n         */\n        function getMousePosition(evt) {\n            var CTM = el.getScreenCTM();\n            if (evt.touches) {\n                evt = evt.touches[0];\n            }\n            return {\n                x: (evt.clientX - CTM.e) / CTM.a,\n                y: (evt.clientY - CTM.f) / CTM.d\n            };\n        }\n\n        /**\n         * Function called whenn dragging starts.\n         * @param {*} evt\n         */\n        function startDrag(evt) {\n            evt.preventDefault();\n            if (evt.target.classList.contains('learningmap-draggable')) {\n                selectedElement = evt.target;\n                offset = getMousePosition(evt);\n                offset.x -= parseInt(selectedElement.getAttributeNS(null, \"cx\"));\n                offset.y -= parseInt(selectedElement.getAttributeNS(null, \"cy\"));\n                // Get paths that need to be updated.\n                upd1 = placestore.getPathsWithFid(selectedElement.id);\n                upd2 = placestore.getPathsWithSid(selectedElement.id);\n            }\n        }\n\n        /**\n         * Function called during dragging. Continuously updates circles center coordinates and the\n         * coordinates of the touching paths.\n         * @param {*} evt\n         */\n        function drag(evt) {\n            evt.preventDefault();\n            if (selectedElement) {\n                var coord = getMousePosition(evt);\n                let cx = coord.x - offset.x;\n                let cy = coord.y - offset.y;\n                selectedElement.setAttributeNS(null, \"cx\", cx);\n                selectedElement.setAttributeNS(null, \"cy\", cy);\n\n                upd1.forEach(function(p) {\n                    let d = document.getElementById(p.id);\n                    if (!(d === null)) {\n                        if (d.nodeName == 'path') {\n                            let pathDeclaration = d.getAttribute('d');\n                            let newPathDeclaration = 'M ' + cx + ' ' + cy + ' L' + pathDeclaration.split('L')[1];\n                            d.setAttribute('d', newPathDeclaration);\n                        } else {\n                            d.setAttribute('x1', cx);\n                            d.setAttribute('y1', cy);\n                        }\n                    }\n                });\n\n                upd2.forEach(function(p) {\n                    let d = document.getElementById(p.id);\n                    if (!(d === null)) {\n                        if (d.nodeName == 'path') {\n                            let pathDeclaration = d.getAttribute('d');\n                            let newPathDeclaration = pathDeclaration.split('L')[0] + 'L ' + cx + ' ' + cy;\n                            d.setAttribute('d', newPathDeclaration);\n                        } else {\n                            d.setAttribute('x2', cx);\n                            d.setAttribute('y2', cy);\n                        }\n                    }\n                });\n            }\n        }\n\n        /**\n         * Function called when dragging ends.\n         * @param {*} evt\n         */\n        function endDrag(evt) {\n            evt.preventDefault();\n            selectedElement = null;\n            unselectAll();\n            updateCode();\n        }\n    }\n\n    /**\n     * Updates the form fields for the SVG code and the placestore from the editor.\n     */\n    function updateCode() {\n        if (code && mapdiv) {\n            code.innerHTML = mapdiv.innerHTML;\n        }\n        if (placestoreInput) {\n            document.getElementsByName('placestore')[0].value = JSON.stringify(placestore.getPlacestore());\n        }\n    }\n\n    /**\n     * Handles double clicks on the map\n     * @param {*} event\n     */\n    function dblclickHandler(event) {\n        hideContextMenu();\n        unselectAll();\n        if (event.target.classList.contains('learningmap-mapcontainer') ||\n            event.target.classList.contains('learningmap-background-image')) {\n            addPlace(event);\n        } else if (event.target.classList.contains('learningmap-place')) {\n            if (lastTarget == event.target.id) {\n                lastTarget = null;\n                clickHandler(event);\n            } else {\n                removePlace(event);\n            }\n        } else if (event.target.classList.contains('learningmap-path')) {\n            removePath(event.target.id);\n        }\n        updateCode();\n    }\n\n    /**\n     * Returns an empty title tag with the given id.\n     * @param {*} id id for the title\n     * @returns {any}\n     */\n    function title(id) {\n        let title = document.createElementNS('http://www.w3.org/2000/svg', 'title');\n        title.setAttribute('id', id);\n        return title;\n    }\n\n    /**\n     * Returns a circle tag with the given dimensions.\n     * @param {*} x x coordinate of the center\n     * @param {*} y y coordinate of the center\n     * @param {*} r radius\n     * @param {*} classes classes to add\n     * @param {*} id id of the circle\n     * @returns {any}\n     */\n    function circle(x, y, r, classes, id) {\n        let circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');\n        circle.setAttribute('class', classes);\n        circle.setAttribute('id', id);\n        circle.setAttribute('cx', x);\n        circle.setAttribute('cy', y);\n        circle.setAttribute('r', r);\n        return circle;\n    }\n\n    /**\n     * Returns a path between two points.\n     * @param {*} x1 x coordinate of the first point\n     * @param {*} y1 y coordinate of the first point\n     * @param {*} x2 x coordinate of the second point\n     * @param {*} y2 y coordinate of the second point\n     * @param {*} classes CSS classes to set\n     * @param {*} id id of the path\n     * @returns {any}\n     */\n     function path(x1, y1, x2, y2, classes, id) {\n        let path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\n        path.setAttribute('class', classes);\n        path.setAttribute('id', id);\n        path.setAttribute('d', 'M ' + x1 + ' ' + y1 + ' L ' + x2 + ' ' + y2);\n        return path;\n    }\n\n    /**\n     * Returns a link around a given child element. This function also adds a title element next\n     * to the child for accessibility.\n     * @param {*} child child item to set the link on\n     * @param {*} id id of the link\n     * @param {*} title title of the link\n     * @returns {any}\n     */\n    function link(child, id, title = null) {\n        let link = document.createElementNS('http://www.w3.org/2000/svg', 'a');\n        link.setAttribute('id', id);\n        link.setAttribute('xlink:href', '');\n        link.appendChild(child);\n        if (!(title === null)) {\n            link.appendChild(title);\n        }\n        return link;\n    }\n\n    /**\n     * Adds a place on the SVG map. This function also prepares the code for linking activities\n     * and adding titles (for accessibility).\n     * @param {*} event event causing the command\n     */\n    function addPlace(event) {\n        let placesgroup = document.getElementById('placesGroup');\n        let placeId = 'p' + placestore.getId();\n        let linkId = 'a' + placestore.getId();\n        var CTM = event.target.getScreenCTM();\n        if (event.touches) {\n            event = event.touches[0];\n        }\n        let cx = (event.clientX - CTM.e) / CTM.a;\n        let cy = (event.clientY - CTM.f) / CTM.d;\n        placesgroup.appendChild(\n            link(\n                circle(cx, cy, 10, 'learningmap-place learningmap-draggable learningmap-emptyplace', placeId),\n                linkId,\n                title('title' + placeId)\n            )\n        );\n        placestore.addPlace(placeId, linkId);\n    }\n\n    /**\n     * Handles single clicks on the background image.\n     * @param {*} event click event\n     * @returns {void}\n     */\n    function clickHandler(event) {\n        event.preventDefault();\n        hideContextMenu();\n        if (event.target.classList.contains('learningmap-place') && selectedElement === null) {\n            if (firstPlace === null) {\n                firstPlace = event.target.id;\n                document.getElementById(firstPlace).classList.add('learningmap-selected');\n            } else {\n                secondPlace = event.target.id;\n                let fid = parseInt(firstPlace.replace('p', ''));\n                let sid = parseInt(secondPlace.replace('p', ''));\n                if (sid == fid) {\n                    return;\n                }\n                if (sid < fid) {\n                    let z = sid;\n                    sid = fid;\n                    fid = z;\n                }\n                addPath(fid, sid);\n                let first = document.getElementById(firstPlace);\n                if (first) {\n                    first.classList.remove('learningmap-selected');\n                }\n                firstPlace = null;\n                lastTarget = secondPlace;\n                secondPlace = null;\n            }\n        } else {\n            unselectAll();\n            firstPlace = null;\n        }\n    }\n    /**\n     * Removes the classes 'learningmap-selected' and 'learningmap-selectet-activity-selector'\n     * from all nodes\n     */\n    function unselectAll() {\n        Array.from(document.getElementsByClassName('learningmap-selected')).forEach(function(e) {\n            e.classList.remove('learningmap-selected');\n        });\n        Array.from(document.getElementsByClassName('learningmap-selected-activity-selector')).forEach(function(e) {\n            e.classList.remove('learningmap-selected-activity-selector');\n        });\n    }\n\n    /**\n     * Adds a path between two places.\n     * @param {number} fid id of the first place (meant to be the smaller one)\n     * @param {number} sid id of the second place (meant to be the bigger one)\n     */\n    function addPath(fid, sid) {\n        let pid = 'p' + fid + '_' + sid;\n        if (document.getElementById(pid) === null) {\n            let pathsgroup = document.getElementById('pathsGroup');\n            let first = document.getElementById('p' + fid);\n            let second = document.getElementById('p' + sid);\n            if (pathsgroup && first && second) {\n                pathsgroup.appendChild(\n                    path(\n                        first.cx.baseVal.value,\n                        first.cy.baseVal.value,\n                        second.cx.baseVal.value,\n                        second.cy.baseVal.value,\n                        'learningmap-path',\n                        pid\n                    )\n                );\n                placestore.addPath(pid, 'p' + fid, 'p' + sid);\n            }\n        }\n    }\n\n    /**\n     * Removes a place from the SVG and the placestore. This function also removes all\n     * touching paths and entries in statringplaces / targetplaces linking to the removed\n     * place.\n     * @param {any} event event causing the remove order\n     */\n    function removePlace(event) {\n        let place = document.getElementById(event.target.id);\n        let parent = place.parentNode;\n        removePathsTouchingPlace(event.target.id);\n        placestore.removePlace(event.target.id);\n        parent.removeChild(place);\n        parent.parentNode.removeChild(parent);\n\n        updateCode();\n    }\n\n    /**\n     * Removes all paths touching a certain place\n     * @param {number} id id of the place\n     */\n    function removePathsTouchingPlace(id) {\n        placestore.getTouchingPaths(id).forEach(\n            function(e) {\n                removePath(e.id);\n            }\n        );\n    }\n\n    /**\n     * Removes a path from the SVG and from the placestore\n     * @param {number} id id of the path\n     */\n    function removePath(id) {\n        let path = document.getElementById(id);\n        if (!(path === null)) {\n            path.parentNode.removeChild(path);\n            placestore.removePath(id);\n        }\n    }\n\n    /**\n     * Sets the background image of the SVG to the current image in filemanager.\n     */\n    function refreshBackgroundImage() {\n        let previewimage = document.getElementsByClassName('realpreview');\n        if (previewimage.length > 0) {\n            let background = document.getElementById('learningmap-background-image');\n            background.setAttribute('xlink:href', previewimage[0].getAttribute('src').split('?')[0]);\n        }\n    }\n\n    /**\n     * Adds an eventListener to the background image for watching file changes and updating\n     * height and width of the image.\n     */\n    function registerBackgroundListener() {\n        let background = document.getElementById('learningmap-background-image');\n        if (background) {\n            background.addEventListener('load', function() {\n                background.removeAttribute('height');\n                let height = parseInt(background.getBBox().height);\n                let width = background.getBBox().width;\n                placestore.setBackgroundDimensions(width, height);\n                svg.setAttribute('viewBox', '0 0 ' + placestore.width + ' ' + placestore.height);\n                background.setAttribute('width', width);\n                background.setAttribute('height', height);\n                updateCode();\n            });\n        }\n    }\n\n    /**\n     * Updates CSS code inside the SVG (called, when one of the colors is changed).\n     * Calls updateCode() when completed.\n     */\n    function updateCSS() {\n        Templates.renderForPromise('mod_learningmap/cssskeleton', placestore.getPlacestore())\n            .then(({html, js}) => {\n                Templates.replaceNode('#learningmap-svgstyle', html, js);\n                updateCode();\n                return true;\n            })\n            .catch(ex => displayException(ex));\n    }\n\n    /**\n     * Updates the activity selector to highlight the activities already used\n     */\n    function updateActivities() {\n        let activities = placestore.getAllActivities();\n        let options = Array.from(activitySelector.getElementsByTagName('option'));\n        options.forEach(function(n) {\n            if (activities.includes(n.value)) {\n                n.classList.add('learningmap-used-activity');\n            } else {\n                n.classList.remove('learningmap-used-activity');\n            }\n        });\n    }\n};\n"],"file":"learningmap.min.js"}